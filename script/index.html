<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>upload music for sync</title>
  <link type="text/css" rel="stylesheet" href="css/black.css" /> 
  <link type="text/css" href="css/smoothness/jquery-ui-1.8.8.custom.css" rel="stylesheet" />  
  <link rel="stylesheet" href="css/jquery.fileupload-ui.css">
  <style>
    #sortable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
    #sortable li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1em; height: 18px; }
    #sortable li span { position: absolute; margin-left: -1.3em; }
    #sortable2 { list-style-type: none; margin: 0; padding: 0; width: 60%; }
    #sortable2 li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1em; height: 18px; }
    #sortable2 li span { position: absolute; margin-left: -1.3em; }
    .ui-state-highlight { height: 1.5em; line-height: 1.2em; }
  </style>
  <script src="js/jquery-1.4.4.min.js"></script>
  <script src="js/jquery-ui-1.8.8.custom.min.js"></script>
  <script src="js/jquery.fileupload.js"></script>
  <script src="js/jquery.fileupload-ui.js"></script>
  <script>
  /*global $ */
  $(function () {
      $('.upload').fileUploadUI({
          uploadTable: $('.upload_files'),
          downloadTable: $('.download_files'),
          buildUploadRow: function (files, index) {
              var file = files[index];
              return $(
                  '<tr style="display:none">' +
                  '<td>' + file.name + '<\/td>' +
                  '<td class="file_upload_progress"><div><\/div><\/td>' +
                  '<td class="file_upload_cancel">' +
                  '<div class="ui-state-default ui-corner-all ui-state-hover" title="Cancel">' +
                  '<span class="ui-icon ui-icon-cancel">Cancel<\/span>' +
                  '<\/div>' +
                  '<\/td>' +
                  '<\/tr>'
              );
          },
          buildDownloadRow: function (file) {
              return $(
                  '<tr style="display:none"><td>' + file.name + '<\/td><\/tr>'
              );
          }
      });
      $( "#sortable" ).sortable({
        placeholder: "ui-state-highlight"
      });
      $( "#sortable" ).disableSelection();
  });
  </script> 
  <script type="text/javascript">

  var listedMp3s = {};

  function clearMp3s() {
    $.getJSON("/clear", function(mp3s) {
        console.log(mp3s);
      });
  }

	function getItems()
	{
		var columns = [];
		$("#sortable").each(function(){
			columns.push($(this).sortable('toArray').join(','));				
		});
    console.log(typeof(colums));
		res = columns.join('|');
    console.log('res:' + res);
		return res;
	}

  function renderItems(citems)
	{
		var html = '';
		var columns = citems.split('|');
		for ( var c in columns )
		{
			html += '<div class="column left';
			if ( c === 0 )
			{
				html += ' first';
			}
			html += '"><ul id="sortable2" class="sortable-list">';
			if ( columns[c] !== '' )
			{
				var items = columns[c].split(',');
				for ( var i in items )
				{
					// html += '<li class="sortable-item" id="' + items[i] + '">Sortable item ' + items[i] + '</li>';
          html += '<li id=' + items[i] + 
                  ' class="ui-state-default"><span class="ui-icon ui-icon-volume-on"><\/span><a href="/content/' +
                  items[i] + '">' + items[i] + '<\/a><\/li>';
				}
			}
			html += '</ul></div>';
		}

		$('#renderarea').html(html);
    $( "#sortable2" ).sortable({
      placeholder: "ui-state-highlight"
    });
    $( "#sortable2" ).disableSelection();
	}
  var serverStateCheckSum = 0;
  function checkForUpdated() {
  	console.log("checking for updates...");
    $.get("/sha1", function(sha1) {
    	  var old = serverStateCheckSum;
        serverStateCheckSum = sha1;
    	  if (sha1 !== old) {
          console.log("needs update! sha1:" + sha1);
          setTimeout(loadMp3s,1);
        }
        else {
          console.log("nothing changed... sha1:" + sha1);
          setTimeout(checkForUpdated,5000);
        }
    });
 	
  }
  function loadMp3s() {
    function compareMp3s(a,b){
        return (a.name > b.name) ? 1 : -1;
    }
    $.getJSON("/content", function(mp3s) {

      console.log(mp3s);

      if (mp3s.length > 0){
        $.each(mp3s.sort(compareMp3s), function() {
          if (!listedMp3s[this.name])
          {
            listedMp3s[this.name] = true;
            var newItem = '<li id=' + this.name + 
                  ' class="ui-state-default"><span class="ui-icon ui-icon-volume-on"><\/span><a href="/content/' +
                  this.name  + '">' + this.name + '<\/a><\/li>';
            $("#sortable").append(newItem);
            $("#sortable").sortable('refresh');
          }
        });
      }
      setTimeout(checkForUpdated,5000);
    });
  }
  setTimeout(checkForUpdated, 1000);
  </script>
</head>
<body>
<form class="upload" action="/upload" method="POST" enctype="multipart/form-data">
    <input type="file" name="file" multiple>
    <button>Upload</button>
    <div>drag music files here</div>
</form> 
<table class="upload_files"></table>
<table class="download_files"></table>
<p>list of available mp3s:</p>

<ul id="sortable">
</ul>
<div class="column left first">

  <ul class="sortable-list">
    <li class="sortable-item" id="A">Sortable item A</li>
    <li class="sortable-item" id="B">Sortable item B</li>
  </ul>

</div>



<div id="renderarea"></div>
<div id="manageDiv"><h2>Manage mp3 list</h2></div>
<button type="button" onclick="clearMp3s();">clear all items</button>
<button type="button" onclick="renderItems(getItems());">show all items</button>

</body> 
</html>
